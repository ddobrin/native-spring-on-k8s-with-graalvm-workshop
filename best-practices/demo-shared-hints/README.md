# Complete Demo application, reusing native hints as `shared hints`

----
## The code

This workshop repository can be cloned to your machine as follows:
```shell
> git clone https://github.com/ddobrin/native-spring-on-k8s-with-graalvm
```

**`Full example code is provided for this section !`**

This example sample is relative to the repository root:
```shell
<repo-root>/best-practices/demo-shared-hints
```
----

## The sample
Let's use as an example the `Demo` application in the [Troubleshooting](../troubleshooting/README.md) section and abstract all @NativeHints
into a separate `hints library`, now shareable across multiple applications.

We'll build this shared library in the [Shared Hints](../shared-hints/README.md) section, for illustration, then reuse the library in the `Demo` app.

The app does not declare the Native Hints, however leverages them from the `shared-hints` project.

To this end, the `pom.xml` must be modified to include the definitions of the shared hints:
```xml
...
<plugin>
    <groupId>org.springframework.experimental</groupId>
    <artifactId>spring-aot-maven-plugin</artifactId>
    <version>${spring-native.version}</version>
    <dependencies>
        <dependency>
            <groupId>com.example</groupId>
            <artifactId>shared-hints</artifactId>
            <version>0.0.1</version>
        </dependency>
    </dependencies>
...
```

Let's now rebuild the `Demo app` and observe its behavior.
```shell
> ./mvnw clean package
```

**Observe that** running in the IDE fails right away. The Maven <goal> `spring-aot:generate` has not been executed.
```shell
***************************
APPLICATION FAILED TO START
***************************

Description:

The ApplicationContext could not start as 'org.springframework.aot.StaticSpringFactories' that is generated by the Spring AOT plugin could not be found.

Action:

Review your local configuration and make sure that the Spring AOT plugin is configured properly.
If you're trying to run your application with 'mvn spring-boot:run', please use 'mvn package spring-boot:run' instead.
See https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/#spring-aot for more details.
```

**To fix it** run the Spring AOT plugin first, then reload from disk in the IDE.
<br>Alternatively, you can modify the settings in your preferred IDE, as per the [Spring AOT documentation](https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/#spring-aot).
```shell
./mvnw clean package spring-boot:generate
```

The app runs correctly in the IDE or Terminal:
```
...
    2021-05-03 13:10:45.475  INFO 55342 --- [           main] com.example.demo.DemoApplication         : Starting DemoApplication using Java 11.0.10 on ddobrin-a01.vmware.com with PID 55342 (/Users/dandobrin/work/native/native-spring-on-k8s-with-graalvm-workshop/best-practices/demo-shared-hints/target/classes started by dandobrin in /Users/dandobrin/work/native/native-spring-on-k8s-with-graalvm-workshop/best-practices/demo-shared-hints)
    2021-05-03 13:10:45.475  INFO 55342 --- [           main] com.example.demo.DemoApplication         : No active profile set, falling back to default profiles: default
    2021-05-03 13:10:45.689  INFO 55342 --- [           main] com.example.demo.DemoApplication         : Started DemoApplication in 0.398 seconds (JVM running for 0.626)
    2021-05-03 13:10:45.698  INFO 55342 --- [           main] com.example.demo.Initializer             : Assign unique ID to a Bear: 7d82971c-d13a-4492-92ba-a636dd56ea61
    2021-05-03 13:10:45.708  INFO 55342 --- [           main] com.example.demo.DemoApplication         : Before interception...
    2021-05-03 13:10:45.708  INFO 55342 --- [           main] com.example.demo.Initializer             : Invoke talk(). Proxied message: Proxied method: Bear talks() ... After interception...
    2021-05-03 13:10:45.708  INFO 55342 --- [           main] com.example.demo.DemoApplication         : Before interception...
    2021-05-03 13:10:45.708  INFO 55342 --- [           main] com.example.demo.Initializer             : Invoke eat(). Proxied message: No method intercepted. Bear must be eat()ing ... After interception...
    2021-05-03 13:10:45.708  INFO 55342 --- [           main] com.example.demo.Initializer             : Serialize the ID assigned to the bear to the file: bear-id
```

Build the native image now and observe that the behavior is still correct.

**Note:** the start-up time is down to 0.014s in this test, down from 0.398s ! Super-fast!
```shell
> ./mvnw clean spring-boot:build-image

> docker run --rm demo-shared-hints:0.0.1

2021-05-03 17:20:05.870  INFO 1 --- [           main] o.s.nativex.NativeListener               : This application is bootstrapped with code generated with Spring AOT

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.4.5)

2021-05-03 17:20:05.871  INFO 1 --- [           main] com.example.demo.DemoApplication         : Starting DemoApplication using Java 11.0.10 on 98fbe831ce9b with PID 1 (/workspace/com.example.demo.DemoApplication started by cnb in /workspace)
2021-05-03 17:20:05.871  INFO 1 --- [           main] com.example.demo.DemoApplication         : No active profile set, falling back to default profiles: default
2021-05-03 17:20:05.879  INFO 1 --- [           main] com.example.demo.DemoApplication         : Started DemoApplication in 0.014 seconds (JVM running for 0.017)
2021-05-03 17:20:05.879  INFO 1 --- [           main] com.example.demo.Initializer             : Assign unique ID to a Bear: e61f51b7-f97b-4cbb-85d5-3b9327c9aca5
2021-05-03 17:20:05.879  INFO 1 --- [           main] com.example.demo.DemoApplication         : Before interception...
2021-05-03 17:20:05.879  INFO 1 --- [           main] com.example.demo.Initializer             : Invoke talk(). Proxied message: Proxied method: Bear talks() ... After interception...
2021-05-03 17:20:05.879  INFO 1 --- [           main] com.example.demo.DemoApplication         : Before interception...
2021-05-03 17:20:05.879  INFO 1 --- [           main] com.example.demo.Initializer             : Invoke eat(). Proxied message: No method intercepted. Bear must be eat()ing ... After interception...
2021-05-03 17:20:05.879  INFO 1 --- [           main] com.example.demo.Initializer             : Serialize the ID assigned to the bear to the file: bear-id
```